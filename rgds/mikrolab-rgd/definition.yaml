apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: mikrolab
  annotations:
    argocd.argoproj.io/instance: mikrolab
  labels:
    app.kubernetes.io/name: mikrolab
    app.kubernetes.io/instance: mikrolab
    app.kubernetes.io/component: infrastructure
    app.kubernetes.io/part-of: mikrolab
    # app.kubernetes.io/managed-by: argocd ## will this be tracked my argocd?

spec:
  schema:
    apiVersion: v1alpha1
    kind: MikroLab
    spec:
   
      env: string | default="staging" enum="staging,production"

      ingress:
        class: string | default="traefik" enum="traefik"
 
      certmanager:
        enabled: boolean | default=true
        provider: string | default="duckdns" enum="duckdns,cloudflare"
        domain: string  
        email: string
    

  resources:

    - id: certManagerArgofile
      readyWhen:
        - ${certManagerArgofile.status.state == "Ready"}
      template:
        apiVersion: kro.run/v1alpha1
        kind: Argofile
        metadata:
          name: platform-argofile
          namespace: platform
        spec:
          applications:
            - name: cert-manager-bundle-loader
              enabled: true  
              hook: PreSync
              destination:
                namespace: cert-manager
              source:
                repoURL: git@github.com:rbellius/resourcegraphdefinitions.git
                targetRevision: main
                path: rgds/cert-manager-bundle-rgd

    # - id: SomeChartArgofile
    #   template:
    #     apiVersion: kro.run/v1alpha1
    #     kind: Argofile
    #     metadata:
    #       name: chart-name-argofile
    #     spec:
    #       applications:
    #         - name: chart-name
    #           enabled: true  
    #           hook: PreSync
    #           syncWave: 0
    #           destination:
    #             namespace: your-namespace
    #           source:
    #             repoURL: git@github.com:user/repo.git
    #             targetRevision: main
    #             path: path/to/yaml # Use chart: for actual helm charts
    #           values: | 
    #             foo:
    #               bar: true


    - id: certManagerNamespace
      template:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: cert-manager
          labels:
            app.kubernetes.io/name: cert-manager
            app.kubernetes.io/instance: cert-manager
            app.kubernetes.io/component: cert-manager
            app.kubernetes.io/part-of: cert-manager
            app.kubernetes.io/managed-by: argocd
            
    - id: certMangerBundle
      includeWhen:
        - ${schema.spec.certmanager.enabled}
      template:
        apiVersion: kro.run/v1alpha1
        kind: CertManangerBundle
        metadata:
          name: cert-manager-bundle
          namespace: cert-manager
          annotations:
            argocd.argoproj.io/instance: cert-manager-bundle
        spec:

          env: ${schema.spec.env}

          ingress:
            class: ${schema.spec.ingress.class}
            requests: true

          dns:
            providers: 
              duckdns:
                enabled: ${schema.spec.certmanager.provider == "duckdns"}
                email: ${schema.spec.certmanager.email}
                domain: ${schema.spec.certmanager.domain}
                dynamic: true
              # cloudflare:
              #   enabled: false
              #   email: eddie.moya@gmail.com
              #   domain: cloudbreaker.me
              builtin:
                enabled: ${schema.spec.certmanager.provider == "cloudflare"}
                provider: cloudflare
                email: ${schema.spec.certmanager.email}
                domain: ${schema.spec.certmanager.domain}
              default:
                provider: ${schema.spec.certmanager.provider}
                domain: ${schema.spec.certmanager.domain}

    
    - id: arkrocdBundle
      # dependsOn: 
      #     - certMangerBundle
      template:
        apiVersion: kro.run/v1alpha1
        kind: ArkroCDBundle
        metadata:
          name: staging-arkrocd-bundle
          namespace: argocd
          annotations:
            argocd.argoproj.io/instance: arkrocd-bundle